---

title: Title
keywords: fastai
sidebar: home_sidebar

summary: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: node2vec.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">KMeans</span>
<span class="kn">import</span> <span class="nn">pprint</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-Prepare-input-for-node2vec">1. Prepare input for node2vec<a class="anchor-link" href="#1.-Prepare-input-for-node2vec">&#182;</a></h2><blockquote><p>We'll use a CSV file where each row represents a single recommendable item: it contains a comma separated list of the named entities that appear in the item's title.
一个样本为一个序列特征。</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">named_entities_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../output/event_features.csv&#39;</span><span class="p">)</span>
<span class="n">named_entities_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;named_entities&#39;</span><span class="p">]</span>
<span class="c1"># named_entities_df[&#39;named_entities&#39;] = named_entities_df.named_entities.str.replace(&quot; &quot;, &quot;,&quot;)</span>
<span class="c1"># 为了适配代码才做的</span>
<span class="n">named_entities_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>named_entities</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3bfd1a65 a52b92d5 7da34a02 25fa8af4</td>
    </tr>
    <tr>
      <th>1</th>
      <td>f56e0afc ec138c1c 4a4c3d21 e37a2b78 17113b36 4...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>c74f40cd c74f40cd a52b92d5 7da34a02 7da34a02 f...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3bfd1a65 a1e4395d c74f40cd 28ed704e a1e4395d 7...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7525289a f6947f54 bdf49a58</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>First, we'll have to tokenize the named entities, since <code>node2vec</code> expects integers.</p>
</blockquote>
<p>处理成节点特征。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tokenizer</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="n">named_entities_df</span><span class="p">[</span><span class="s1">&#39;named_entities&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">named_entities_df</span><span class="p">[</span><span class="s1">&#39;named_entities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">named_entities</span><span class="p">:</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">named_entitie</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">))</span> <span class="k">for</span> <span class="n">named_entitie</span> <span class="ow">in</span> <span class="n">named_entities</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">named_entities_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="c1"># https://blog.csdn.net/u012535605/article/details/81709834</span>
<span class="c1"># astype(str)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>named_entities</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>[0, 1, 2, 3]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>[4, 5, 6, 7, 8, 6, 9, 6, 7, 8, 8, 9, 9, 6]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>[10, 10, 1, 2, 2, 11, 12, 10]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>[0, 13, 10, 14, 13, 2, 12, 15]</td>
    </tr>
    <tr>
      <th>4</th>
      <td>[16, 17, 18]</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[(&#39;3bfd1a65&#39;, 0),
 (&#39;a52b92d5&#39;, 1),
 (&#39;7da34a02&#39;, 2),
 (&#39;25fa8af4&#39;, 3),
 (&#39;f56e0afc&#39;, 4)]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;一共有&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="p">,</span><span class="s1">&#39;event&#39;</span><span class="p">,</span><span class="s1">&#39;对它们进行 embedding&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>一共有 98 event 对它们进行 embedding
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to construct the graph on which we'll run node2vec, we first need to understand which named entities appear together.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">named_entities_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(17690, 1)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pairs_df</span> <span class="o">=</span> <span class="n">named_entities_df</span><span class="p">[</span><span class="s1">&#39;named_entities&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">named_entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">named_entities</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="p">[</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;named_entity_1&#39;</span><span class="p">,</span> <span class="s1">&#39;named_entity_2&#39;</span><span class="p">])</span>
<span class="n">pairs_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>named_entity_1</th>
      <th>named_entity_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pairs_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(1011209, 2)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can construct the graph. The weight of an edge connecting two named entities will be the number of times these named entities appear together in our dataset.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pairs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;named_entity_1&#39;</span><span class="p">,</span> <span class="s1">&#39;named_entity_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>named_entity_1</th>
      <th>named_entity_2</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>452</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>2</td>
      <td>1251</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>3</td>
      <td>229</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>10</td>
      <td>454</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>11</td>
      <td>645</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">NAMED_ENTITIES_CO_OCCURENCE_THRESHOLD</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># By default, 25</span>

<span class="n">edges_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;named_entity_1&#39;</span><span class="p">,</span> <span class="s1">&#39;named_entity_2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>
<span class="n">edges_df</span> <span class="o">=</span> <span class="n">edges_df</span><span class="p">[</span><span class="n">edges_df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">NAMED_ENTITIES_CO_OCCURENCE_THRESHOLD</span><span class="p">]</span>
<span class="n">edges_df</span><span class="p">[[</span><span class="s1">&#39;named_entity_1&#39;</span><span class="p">,</span> <span class="s1">&#39;named_entity_2&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;edges.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="c1"># 为了作为文本输入，这里需要按照`&#39; &#39;`进行切分</span>
<span class="c1"># https://github.com/aditya-grover/node2vec/issues/42</span>
<span class="n">edges_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>named_entity_1</th>
      <th>named_entity_2</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>452</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>2</td>
      <td>1251</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>3</td>
      <td>229</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>10</td>
      <td>454</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>11</td>
      <td>645</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">edges_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(1381, 3)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we'll run <code>node2vec</code>, which will output the result embeddings in a file called <code>emb</code>.<br>
We'll use the open source implementation developed by <a href="https://github.com/snap-stanford/snap/tree/master/examples/node2vec">Stanford</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># !git clone https://github.com/JiaxiangBU/node2vec.git</span>
<span class="c1"># 下载后，调用 node2vec 代码，基于 word2vec 开发，我调整了 Python 3 版本适用。</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python node2vec/src/main.py --input edges.csv --output emb --weighted
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Walk iteration:
1 / 10
2 / 10
3 / 10
4 / 10
5 / 10
6 / 10
7 / 10
8 / 10
9 / 10
10 / 10
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="2.-Read-embedding-and-run-KMeans-clusterring:">2. Read embedding and run KMeans clusterring:<a class="anchor-link" href="#2.-Read-embedding-and-run-KMeans-clusterring:">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">emb_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;emb&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">emb_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">emb_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;named_entity&#39;</span>
<span class="n">emb_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
      <th>...</th>
      <th>119</th>
      <th>120</th>
      <th>121</th>
      <th>122</th>
      <th>123</th>
      <th>124</th>
      <th>125</th>
      <th>126</th>
      <th>127</th>
      <th>128</th>
    </tr>
    <tr>
      <th>named_entity</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>51</th>
      <td>0.201396</td>
      <td>0.396243</td>
      <td>-0.266897</td>
      <td>-0.580919</td>
      <td>0.309138</td>
      <td>-0.215859</td>
      <td>0.177556</td>
      <td>-0.281016</td>
      <td>-0.131219</td>
      <td>-0.013089</td>
      <td>...</td>
      <td>-0.158429</td>
      <td>0.280645</td>
      <td>0.427394</td>
      <td>-0.277015</td>
      <td>-0.268398</td>
      <td>0.309646</td>
      <td>0.308136</td>
      <td>0.149765</td>
      <td>0.139561</td>
      <td>0.137682</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.377510</td>
      <td>0.117800</td>
      <td>-0.568410</td>
      <td>-0.389599</td>
      <td>0.084741</td>
      <td>-0.241372</td>
      <td>-0.283782</td>
      <td>-0.203280</td>
      <td>-0.153969</td>
      <td>-0.230429</td>
      <td>...</td>
      <td>0.138216</td>
      <td>0.316665</td>
      <td>0.105284</td>
      <td>-0.261846</td>
      <td>-0.602530</td>
      <td>0.031347</td>
      <td>-0.658672</td>
      <td>-0.371573</td>
      <td>-0.082173</td>
      <td>-0.061790</td>
    </tr>
    <tr>
      <th>35</th>
      <td>0.086804</td>
      <td>-0.426829</td>
      <td>-0.116550</td>
      <td>-0.151494</td>
      <td>-0.107983</td>
      <td>-0.178468</td>
      <td>0.257112</td>
      <td>-0.354095</td>
      <td>0.221099</td>
      <td>-0.242830</td>
      <td>...</td>
      <td>-0.095036</td>
      <td>0.616571</td>
      <td>0.214014</td>
      <td>-0.083181</td>
      <td>-0.456401</td>
      <td>0.249818</td>
      <td>0.158148</td>
      <td>0.136226</td>
      <td>0.003339</td>
      <td>-0.519082</td>
    </tr>
    <tr>
      <th>24</th>
      <td>0.049161</td>
      <td>-0.354999</td>
      <td>-0.165840</td>
      <td>0.084412</td>
      <td>-0.240874</td>
      <td>-0.380403</td>
      <td>0.409854</td>
      <td>0.238315</td>
      <td>-0.265640</td>
      <td>-0.333510</td>
      <td>...</td>
      <td>0.043810</td>
      <td>0.042521</td>
      <td>0.263100</td>
      <td>0.179329</td>
      <td>-0.232597</td>
      <td>0.271666</td>
      <td>0.244623</td>
      <td>-0.231822</td>
      <td>-0.327294</td>
      <td>0.041148</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0.034572</td>
      <td>-0.339031</td>
      <td>-0.173325</td>
      <td>0.068606</td>
      <td>-0.245434</td>
      <td>-0.380075</td>
      <td>0.410750</td>
      <td>0.238807</td>
      <td>-0.279120</td>
      <td>-0.341910</td>
      <td>...</td>
      <td>0.054638</td>
      <td>0.022407</td>
      <td>0.265012</td>
      <td>0.188955</td>
      <td>-0.232845</td>
      <td>0.279593</td>
      <td>0.242585</td>
      <td>-0.242018</td>
      <td>-0.338466</td>
      <td>0.055907</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 128 columns</p>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">emb_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(97, 128)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>基本上每个类别都有 embedding 了。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Each column is a dimension in the embedding space. Each row contains the dimensions of the embedding of one named entity.</p>
</blockquote>
<p>每一列是一个 embedding 的维度。</p>
<blockquote><p>We'll now cluster the embeddings using a simple clustering algorithm such as k-means.</p>
</blockquote>
<p>下面利用 embedding 进行聚类。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">NUM_CLUSTERS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1"># By default 10</span>

<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">NUM_CLUSTERS</span><span class="p">)</span>
<span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">emb_df</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">emb_df</span><span class="p">)</span>
<span class="n">emb_df</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
<span class="n">clusters_df</span> <span class="o">=</span> <span class="n">emb_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;named_entity&#39;</span><span class="p">,</span><span class="s1">&#39;cluster&#39;</span><span class="p">]]</span>
<span class="n">clusters_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>named_entity</th>
      <th>cluster</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>51</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>35</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>24</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3.-Prepare-input-for-Gephi:">3. Prepare input for Gephi:<a class="anchor-link" href="#3.-Prepare-input-for-Gephi:">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="https://gephi.org">Gephi</a> (Java 1.8 or higher) is a nice visualization tool for graphical data.<br>
We'll output our data into a format recognizable by Gephi.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">id_to_named_entity</span> <span class="o">=</span> <span class="p">{</span><span class="n">named_entity_id</span><span class="p">:</span> <span class="n">named_entity</span>
                      <span class="k">for</span> <span class="n">named_entity</span><span class="p">,</span> <span class="n">named_entity_id</span> <span class="ow">in</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;clusters.gdf&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;nodedef&gt;name VARCHAR,cluster_id VARCHAR,label VARCHAR</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">clusters_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;named_entity&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">],</span> <span class="n">id_to_named_entity</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;named_entity&#39;</span><span class="p">]]))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;edgedef&gt;node1 VARCHAR,node2 VARCHAR, weight DOUBLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">edges_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span> 
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="s1">,</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;named_entity_1&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;named_entity_2&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, we can open <code>clusters.gdf</code> using Gephi in order to inspect the clusters.</p>

</div>
</div>
</div>
</div>
 

